<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../", thisFile = "core/server/data/migration/index.js", defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>
  <script src="../../../../fileSearch.js"></script>
  <link rel="stylesheet" href="../../../../fileSearch.css" />
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h3">
        <a href="#reset">Reset</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">_</span>               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">),</span>
    <span class="nx">when</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;when&#39;</span><span class="p">),</span>
    <span class="nx">path</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
    <span class="nx">fs</span>              <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="nx">nodefn</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;when/node&#39;</span><span class="p">),</span>
    <span class="nx">errors</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../errors&#39;</span><span class="p">),</span>
    <span class="nx">sequence</span>        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;when/sequence&#39;</span><span class="p">),</span>

    <span class="nx">versioning</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../versioning&#39;</span><span class="p">),</span>
    <span class="nx">Setting</span>        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../models/settings&#39;</span><span class="p">).</span><span class="nx">Setting</span><span class="p">,</span>
    <span class="nx">fixtures</span>        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../fixtures&#39;</span><span class="p">),</span>
    <span class="nx">schema</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../schema&#39;</span><span class="p">).</span><span class="nx">collections</span><span class="p">,</span>
    <span class="nx">dataExport</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../export&#39;</span><span class="p">),</span>
    <span class="nx">utils</span>           <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils&#39;</span><span class="p">),</span>
    <span class="nx">config</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../config&#39;</span><span class="p">),</span>

    <span class="nx">schemaCollections</span>    <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">schema</span><span class="p">),</span>

    <span class="nx">init</span><span class="p">,</span>
    <span class="nx">reset</span><span class="p">,</span>
    <span class="nx">migrateUp</span><span class="p">,</span>
    <span class="nx">migrateUpFreshDb</span><span class="p">;</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Check for whether data is needed to be bootstrapped or not</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>There are 4 possibilities:
1. The database exists and is up-to-date
2. The database exists but is out of date
3. The database exists but the currentVersion setting does not or cannot be understood
4. The database has not yet been created</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">versioning</span><span class="p">.</span><span class="nx">getDatabaseVersion</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">databaseVersion</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">defaultVersion</span> <span class="o">=</span> <span class="nx">versioning</span><span class="p">.</span><span class="nx">getDefaultDatabaseVersion</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">databaseVersion</span> <span class="o">===</span> <span class="nx">defaultVersion</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<ol>
<li>The database exists and is up-to-date</li>
</ol>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="nx">when</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">databaseVersion</span> <span class="o">&lt;</span> <span class="nx">defaultVersion</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<ol>
<li>The database exists but is out of date
Migrate to latest version</li>
</ol>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">migrateUp</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>Finally update the databases current version</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">return</span> <span class="nx">versioning</span><span class="p">.</span><span class="nx">setDatabaseVersion</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">databaseVersion</span> <span class="o">&gt;</span> <span class="nx">defaultVersion</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<ol>
<li>The database exists but the currentVersion setting does not or cannot be understood
In this case we don't understand the version because it is too high</li>
</ol>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">errors</span><span class="p">.</span><span class="nx">logErrorAndExit</span><span class="p">(</span>
                <span class="s1">&#39;Your database is not compatible with this version of iCollege&#39;</span><span class="p">,</span>
                <span class="s1">&#39;You will need to create a new database&#39;</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="o">||</span> <span class="nx">err</span> <span class="o">===</span> <span class="s1">&#39;No Database version could be found, settings collection does not exist?&#39;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<ol>
<li>The database has not yet been created
Bring everything up from initial version.</li>
</ol>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">migrateUpFreshDb</span><span class="p">();</span>
        <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<ol>
<li>The database exists but the currentVersion setting does not or cannot be understood
In this case the setting was missing or there was some other problem</li>
</ol>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">errors</span><span class="p">.</span><span class="nx">logErrorAndExit</span><span class="p">(</span><span class="s1">&#39;There is a problem with the database&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="o">||</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="reset">
  <h3>
    <a href="#reset" name="reset" class="pilcrow">&#182;</a>
    Reset
  </h3>
</div>


<p>Delete all tables from the database in reverse order
<strong>only if all collections in schema.js exist! we can safely use this function</strong></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">collections</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">schemaCollections</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">dropCollection</span><span class="p">(</span><span class="nx">collection</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}).</span><span class="nx">reverse</span><span class="p">();</span>


    <span class="k">return</span> <span class="nx">sequence</span><span class="p">(</span><span class="nx">collections</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>Only do this if we have no database at all
no version, no all; delete all collections in this database</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">migrateUpFreshDb</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">collections</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">schemaCollections</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="nx">collection</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>drop all exists!</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">safeDropCollections</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>sequence creations</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">return</span> <span class="nx">sequence</span><span class="p">(</span><span class="nx">collections</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>Load the fixtures</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="nx">fixtures</span><span class="p">.</span><span class="nx">populateFixtures</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>Initialise the default settings</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">return</span> <span class="nx">Setting</span><span class="p">.</span><span class="nx">populateDefaults</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Backup data into a json file</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">*
</span>
      <span>{*}</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">backupDatabase</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">dataExport</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">exportedData</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Save the exported data to the file system for download</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">config</span><span class="p">().</span><span class="nx">paths</span><span class="p">.</span><span class="nx">contentPath</span> <span class="o">+</span> <span class="s1">&#39;/data/exported-&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">nodefn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">exportedData</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>Migrate from a specific version to the latest</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">migrateUp</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nx">backupDatabase</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">migrateUpFreshDb</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">init</span><span class="o">:</span> <span class="nx">init</span><span class="p">,</span>
    <span class="nx">reset</span><span class="o">:</span> <span class="nx">reset</span><span class="p">,</span>
    <span class="nx">migrateUp</span><span class="o">:</span> <span class="nx">migrateUp</span><span class="p">,</span>
    <span class="nx">migrateUpFreshDb</span><span class="o">:</span> <span class="nx">migrateUpFreshDb</span>
<span class="p">};</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>

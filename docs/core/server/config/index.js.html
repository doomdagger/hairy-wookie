<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../", thisFile = "core/server/config/index.js", defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>
  <script src="../../../fileSearch.js"></script>
  <link rel="stylesheet" href="../../../fileSearch.css" />
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>这个模块维护着一个全局的icollegeConfig对象</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">module</div>
    <div class="dox_tag_detail">
      <span>core/server/config</span>
    </div>
    <div class="dox_tag_title">Type</div>
    <div class="dox_tag_detail">
      <span class="dox_type">exports
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>General entry point for all configuration data</p>

<p>This file itself is a wrapper for the root level config.js file.
All other files that need to reference config.js should use this file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">path</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span> <span class="c1">// built-in path module</span>
    <span class="nx">when</span>             <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;when&#39;</span><span class="p">),</span>   <span class="c1">// when - promise implementation</span>
    <span class="nx">url</span>           <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">),</span> <span class="c1">// built-in url module</span>
    <span class="nx">_</span>             <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">),</span>  <span class="c1">// lodash</span>
    <span class="nx">configUrl</span>     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./url&#39;</span><span class="p">),</span><span class="c1">// url.js in the same folder</span>
    <span class="nx">icollegeConfig</span>   <span class="o">=</span> <span class="p">{},</span>
    <span class="nx">appRoot</span><span class="p">,</span> <span class="c1">// the root of the project</span>
    <span class="nx">corePath</span><span class="p">;</span> <span class="c1">// the core folder</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>传入一个config对象，用以更新全局的icollegeConfig对象，理论上，该方法不应当被重复
调用多次。该方法主要更新config的paths信息，而且还是更新url模块的icollegeConfig对象。</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">config</span>
      <span class="dox_type">Object</span>
      <span><ul>
<li>a config object most likely to be your config.js</li>
</ul></span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">
</span>
      <span>{{}}</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">updateConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">localPath</span><span class="p">,</span>
        <span class="nx">contentPath</span><span class="p">,</span>
        <span class="nx">subdir</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Merge passed in config object onto
the cached icollegeConfig object</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">_</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">icollegeConfig</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>must have appRoot and configExample paths</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">appRoot</span>       <span class="o">=</span> <span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">appRoot</span><span class="p">;</span> <span class="c1">// the root of the project</span>
    <span class="nx">corePath</span>      <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">appRoot</span><span class="p">,</span> <span class="s1">&#39;core/&#39;</span><span class="p">);</span> <span class="c1">// the core folder</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>Protect against accessing a non-existant object.
This ensures there's always at least a paths object
because it's referenced in multiple places.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span> <span class="o">=</span> <span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span> <span class="o">||</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Parse local path location, in config.example.js, url should be <a href='http://icollege.com'>http://icollege.com</a>, path should be '/'</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">localPath</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">path</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Remove trailing slash</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">localPath</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">localPath</span> <span class="o">=</span> <span class="nx">localPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">subdir</span> <span class="o">=</span> <span class="nx">localPath</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">localPath</span><span class="p">;</span> <span class="c1">// subdir == &#39;&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Allow contentPath to be over-written by passed in config object
Otherwise default to default content path location</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">contentPath</span> <span class="o">=</span> <span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">contentPath</span> <span class="o">||</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">appRoot</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">);</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">icollegeConfig</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;appRoot&#39;</span><span class="o">:</span>          <span class="nx">appRoot</span><span class="p">,</span>
            <span class="s1">&#39;subdir&#39;</span><span class="o">:</span>           <span class="nx">subdir</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="o">:</span>           <span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">config</span> <span class="o">||</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">appRoot</span><span class="p">,</span> <span class="s1">&#39;config.js&#39;</span><span class="p">),</span>
            <span class="s1">&#39;configExample&#39;</span><span class="o">:</span>    <span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">configExample</span> <span class="o">||</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">appRoot</span><span class="p">,</span> <span class="s1">&#39;config.example.js&#39;</span><span class="p">),</span>
            <span class="s1">&#39;corePath&#39;</span><span class="o">:</span>         <span class="nx">corePath</span><span class="p">,</span>
            <span class="s1">&#39;clientPath&#39;</span><span class="o">:</span>       <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">corePath</span><span class="p">,</span> <span class="s1">&#39;client/&#39;</span><span class="p">),</span> <span class="c1">// the client folder</span>

            <span class="s1">&#39;contentPath&#39;</span><span class="o">:</span>      <span class="nx">contentPath</span><span class="p">,</span>
            <span class="s1">&#39;appPath&#39;</span><span class="o">:</span>          <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">contentPath</span><span class="p">,</span> <span class="s1">&#39;apps&#39;</span><span class="p">),</span>
            <span class="s1">&#39;imagesPath&#39;</span><span class="o">:</span>       <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">contentPath</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">),</span>
            <span class="s1">&#39;imagesRelPath&#39;</span><span class="o">:</span>    <span class="s1">&#39;content/images&#39;</span><span class="p">,</span>

            <span class="s1">&#39;exportPath&#39;</span><span class="o">:</span>       <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">corePath</span><span class="p">,</span> <span class="s1">&#39;/server/data/export/&#39;</span><span class="p">),</span>
            <span class="s1">&#39;lang&#39;</span><span class="o">:</span>             <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">corePath</span><span class="p">,</span> <span class="s1">&#39;/shared/lang/&#39;</span><span class="p">),</span>

            <span class="s1">&#39;availableApps&#39;</span><span class="o">:</span>    <span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">availableApps</span> <span class="o">||</span> <span class="p">[],</span>
            <span class="s1">&#39;builtPath&#39;</span><span class="o">:</span>        <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">corePath</span><span class="p">,</span> <span class="s1">&#39;built/&#39;</span><span class="p">),</span>
            <span class="s1">&#39;builtScriptPath&#39;</span><span class="o">:</span>  <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">corePath</span><span class="p">,</span> <span class="s1">&#39;built/scripts/&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>Also pass config object to
configUrl object to maintain
clean depedency tree</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">configUrl</span><span class="p">.</span><span class="nx">setConfig</span><span class="p">(</span><span class="nx">icollegeConfig</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">icollegeConfig</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>should return a promise</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">rawConfig</span>
      <span class="dox_type">Object</span>
      <span><ul>
<li>此对象应是config.js中的某一个子对象</li>
</ul></span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">*
</span>
      <span>{*}</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">initConfig</span><span class="p">(</span><span class="nx">rawConfig</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>Cache the config.js object's environment
object so we can later refer to it.
Note: this is not the entirety of config.js,
just the object appropriate for this NODE_ENV</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">icollegeConfig</span> <span class="o">=</span> <span class="nx">updateConfig</span><span class="p">(</span><span class="nx">rawConfig</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>@TODO: deep search the apps in content/apps folder for available apps, should be returned as a promise</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="k">return</span> <span class="nx">when</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">icollegeConfig</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>initConfig()方法只会在项目初始化时被调用，此方法应该作为唯一对外出口供其他模块
获取到全局的icollegeConfig对象.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">
</span>
      <span>{{}}</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">config</span><span class="p">()</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>@TODO: get rid of require statement.
This is currently needed for tests to load config file
successfully.  While running application we should never
have to directly delegate to the config.js file. Just remove
this block, everything will work fine.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">icollegeConfig</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">icollegeConfig</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;../../../&#39;</span><span class="p">,</span> <span class="s1">&#39;config.js&#39;</span><span class="p">))[</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="p">]</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">ignore</span><span class="p">)</span> <span class="p">{</span><span class="cm">/*jslint strict: true */</span><span class="p">}</span>

        <span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span> <span class="o">=</span> <span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">appRoot</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;../../../&#39;</span><span class="p">);</span><span class="c1">//app still not bootstrapped, cannot fetch app root from config module</span>
        <span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">configExample</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">icollegeConfig</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">appRoot</span><span class="p">,</span> <span class="s1">&#39;config.example.js&#39;</span><span class="p">);</span>

        <span class="nx">icollegeConfig</span> <span class="o">=</span> <span class="nx">updateConfig</span><span class="p">(</span><span class="nx">icollegeConfig</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>expose config object to others, never invoke it before the project get bootstrapped!</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">icollegeConfig</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">config</span><span class="p">;</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="nx">initConfig</span><span class="p">;</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">urlFor</span> <span class="o">=</span> <span class="nx">configUrl</span><span class="p">.</span><span class="nx">urlFor</span><span class="p">;</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">urlForPost</span> <span class="o">=</span> <span class="nx">configUrl</span><span class="p">.</span><span class="nx">urlForPost</span><span class="p">;</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
